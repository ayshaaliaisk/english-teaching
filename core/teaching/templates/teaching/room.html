{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="flex h-screen bg-gray-100">
    <!-- Sidebar -->
    <div class="w-64 bg-white shadow-lg">
        <div class="p-4">
            <button id="newChat" class="w-full bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600">
                New Chat
            </button>
        </div>
        <div class="mt-4">
            <h2 class="px-4 text-sm font-semibold text-gray-600">Recent Chats</h2>
            <div id="chatList" class="mt-2">
                <!-- Chat history will be populated here -->
            </div>
        </div>
    </div>

    <!-- Main Chat Area -->
    <div class="flex-1 flex flex-col">
        <!-- Chat Messages -->
        <div id="chatMessages" class="flex-1 overflow-y-auto p-4 space-y-4">
            {% for message in messages %}
            <div class="flex {% if message.role == 'user' %}justify-end{% endif %}">
                <div class="max-w-2xl {% if message.role == 'user' %}bg-blue-500 text-white{% else %}bg-white{% endif %} rounded-lg p-4 shadow">
                    <p>{{ message.content }}</p>
                    {% if message.spelling_score is not None %}
                    <div class="mt-2 text-sm {% if message.role == 'user' %}text-blue-100{% else %}text-gray-600{% endif %}">
                        <p>Spelling Score: {{ message.spelling_score }}%</p>
                        <p>Original Text: {{ message.original_text }}</p>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- Input Area -->
        <div class="border-t p-4 bg-white">
            <div class="max-w-4xl mx-auto">
                <div class="flex space-x-4">
                    <button id="micButton" class="p-2 rounded-full hover:bg-gray-100">
                        <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
                        </svg>
                    </button>
                    <div class="flex-1">
                        <textarea id="messageInput" class="w-full p-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" rows="1" placeholder="Type your message..."></textarea>
                    </div>
                    <button id="sendButton" class="bg-blue-500 text-white px-6 py-2 rounded-lg hover:bg-blue-600">
                        Send
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

{% block extra_js %}
<script>
let mediaRecorder;
let audioChunks = [];
let isRecording = false;

document.getElementById('micButton').addEventListener('click', toggleRecording);
document.getElementById('sendButton').addEventListener('click', sendMessage);
document.getElementById('newChat').addEventListener('click', () => window.location.href = "{% url 'room' %}");

function toggleRecording() {
    if (!isRecording) {
        startRecording();
    } else {
        stopRecording();
    }
}

async function startRecording() {
    try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        audioChunks = [];

        mediaRecorder.ondataavailable = (event) => {
            audioChunks.push(event.data);
        };

        mediaRecorder.start();
        isRecording = true;
        document.getElementById('micButton').classList.add('bg-red-500');
    } catch (err) {
        console.error('Error accessing microphone:', err);
    }
}

function stopRecording() {
    mediaRecorder.stop();
    isRecording = false;
    document.getElementById('micButton').classList.remove('bg-red-500');

    mediaRecorder.onstop = () => {
        const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
        const reader = new FileReader();
        reader.readAsDataURL(audioBlob);
        reader.onloadend = () => {
            const base64Audio = reader.result.split(',')[1];
            sendMessage(base64Audio);
        };
    };
}

function sendMessage(audioData = null) {
    const messageInput = document.getElementById('messageInput');
    const message = messageInput.value.trim();
    
    if (!message && !audioData) return;

    const data = {
        message: message,
        audio_data: audioData
    };

    fetch(`{% url 'send_message' room.id %}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        appendMessage(data.user_message, 'user');
        appendMessage(data.assistant_message, 'assistant');
        messageInput.value = '';
    })
    .catch(error => console.error('Error:', error));
}

function appendMessage(message, role) {
    const chatMessages = document.getElementById('chatMessages');
    const messageDiv = document.createElement('div');
    messageDiv.className = `flex ${role === 'user' ? 'justify-end' : ''}`;
    
    let content = `
        <div class="max-w-2xl ${role === 'user' ? 'bg-blue-500 text-white' : 'bg-white'} rounded-lg p-4 shadow">
            <p>${message.content}</p>
    `;

    if (message.spelling_score !== undefined) {
        content += `
            <div class="mt-2 text-sm ${role === 'user' ? 'text-blue-100' : 'text-gray-600'}">
                <p>Spelling Score: ${message.spelling_score}%</p>
                <p>Original Text: ${message.original_text}</p>
            </div>
        `;
    }

    content += '</div>';
    messageDiv.innerHTML = content;
    chatMessages.appendChild(messageDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}
{% endblock %} 